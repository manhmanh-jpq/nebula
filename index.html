<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xmas Pro - Final Stable Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: #00ffff; z-index: 100;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border: 1px solid #00ffff;
        }
        #pip-container { 
            position: absolute; bottom: 20px; right: 20px; width: 220px; height: 160px; 
            border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 100;
        }
        #pip-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #bottom-bar {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .btn { background: #fff; color: #000; padding: 12px 25px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; }
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 1000; color: white;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button class="btn" style="padding: 20px 40px; font-size: 20px;" onclick="startApp()">B·∫¨T √ÇM THANH & CAMERA ƒê·ªÇ XEM</button>
    </div>

    <div id="ui-layer">
        <div style="font-weight: bold; margin-bottom: 5px;">H∆Ø·ªöNG D·∫™N:</div>
        <div style="color: #fff;">‚óè TAY TR√ÅI: Ch·ª•m/X√≤e ƒë·ªÉ ZOOM</div>
        <div style="color: #ff00ff;">‚óè TAY PH·∫¢I: Di chuy·ªÉn ƒë·ªÉ XOAY</div>
    </div>

    <div id="pip-container"><video id="pip-video" autoplay playsinline></video></div>

    <div id="bottom-bar">
        <button class="btn" onclick="capture()">üì∑ CH·ª§P ·∫¢NH</button>
        <button class="btn">üéôÔ∏è QUAY VIDEO (MIC)</button>
    </div>

    <div id="canvas-container"></div>

<script>
    let scene, camera, renderer, treeGroup, textGroup, starPoints;
    let zoomTarget = 1, rotXTarget = 0, rotYTarget = 0;
    let currentZoom = 1, currentRotX = 0, currentRotY = 0;
    let audioCtx, osc, gainNode;

    function startApp() {
        document.getElementById('start-overlay').style.display = 'none';
        initAudio();
        initThree();
        setupHands();
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playSciFi(freqScale) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(200 + freqScale * 200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.02, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
        camera.position.z = 800;

        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        treeGroup = new THREE.Group();
        scene.add(treeGroup);
        textGroup = new THREE.Group();
        scene.add(textGroup);

        // 1. NG√îI SAO H·∫†T B·ª§I
        const sGeo = new THREE.BufferGeometry();
        const sPos = [];
        for(let i=0; i<800; i++) {
            const r = Math.random() * 35;
            const theta = Math.random() * 6.28; const phi = Math.random() * 3.14;
            sPos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
        }
        sGeo.setAttribute('position', new THREE.Float32BufferAttribute(sPos, 3));
        starPoints = new THREE.Points(sGeo, new THREE.PointsMaterial({color: 0xffffaa, size: 2}));
        starPoints.position.y = 320;
        treeGroup.add(starPoints);

        // 2. C√ÇY TH√îNG 10 T·∫¶NG L√Å (G·ªòP H·∫†T)
        for(let i=0; i<10; i++) {
            const r = 280 - i*25;
            const y = -250 + i*60;
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            for(let j=0; j<2500; j++) {
                const a = Math.random() * 6.28;
                const rad = Math.random() * r;
                pPos.push(Math.cos(a)*rad, (Math.random()-0.5)*30, Math.sin(a)*rad);
            }
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            const pLayer = new THREE.Points(pGeo, new THREE.PointsMaterial({color: 0x00ff44, size: 1.5, transparent: true, opacity: 0.8}));
            pLayer.position.y = y;
            treeGroup.add(pLayer);
        }

        // 3. D√ÇY ƒê√àN & B√ìNG ƒê√àN
        const cPts = [];
        for(let i=0; i<=120; i++) {
            const t = i/120; const a = t*Math.PI*18; const rad = (1-t)*290;
            cPts.push(new THREE.Vector3(Math.cos(a)*rad, -260+t*550, Math.sin(a)*rad));
        }
        const spiral = new THREE.Points(new THREE.BufferGeometry().setFromPoints(cPts), new THREE.PointsMaterial({color: 0xffee00, size: 5}));
        treeGroup.add(spiral);

        // 4. G·ªêC
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(30, 35, 100), new THREE.MeshBasicMaterial({color: 0x3d2b1f}));
        trunk.position.y = -310;
        treeGroup.add(trunk);

        // 5. CH·ªÆ & V√ÅCH NGƒÇN
        createLabels();
        animate();
    }

    function createLabels() {
        const loader = new THREE.CanvasTexture(document.createElement('canvas'));
        const makeText = (txt) => {
            const can = document.createElement('canvas'); can.width = 512; can.height = 128;
            const ctx = can.getContext('2d'); ctx.font = "bold 44px Arial"; ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText(txt, 256, 64);
            const spr = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(can), transparent: true, depthTest: false}));
            spr.scale.set(180, 45, 1); return spr;
        };
        const m1 = makeText("Merry Christmas!"); m1.position.z = 30; textGroup.add(m1);
        const m2 = makeText("Tao ch∆∞a c√≥ qu√†"); m2.rotation.y = Math.PI; m2.position.z = -30; textGroup.add(m2);
        
        const divGeo = new THREE.BufferGeometry(); const divP = [];
        for(let i=0; i<1500; i++) divP.push((Math.random()-0.5)*350, (Math.random()-0.5)*150, (Math.random()-0.5)*15);
        divGeo.setAttribute('position', new THREE.Float32BufferAttribute(divP, 3));
        textGroup.add(new THREE.Points(divGeo, new THREE.PointsMaterial({color: 0x222222, size: 1.2})));
    }

    function animate() {
        requestAnimationFrame(animate);
        const diffY = rotYTarget - currentRotY;
        const diffZ = zoomTarget - currentZoom;
        if(Math.abs(diffY) > 0.05 || Math.abs(diffZ) > 0.05) playSciFi(currentZoom);

        currentRotY += diffY * 0.05;
        currentRotX += (rotXTarget - currentRotX) * 0.05;
        currentZoom += diffZ * 0.05;
        
        treeGroup.rotation.y = currentRotY;
        treeGroup.rotation.x = currentRotX;
        textGroup.rotation.y = currentRotY;
        textGroup.rotation.x = currentRotX;
        camera.position.z = 800 - (currentZoom - 1) * 1600;
        textGroup.visible = camera.position.z < 250;
        if(starPoints) starPoints.rotation.y += 0.02;
        renderer.render(scene, camera);
    }

    async function setupHands() {
        const video = document.getElementById('pip-video');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7});
        hands.onResults(res => {
            if(res.multiHandLandmarks && res.multiHandedness) {
                res.multiHandLandmarks.forEach((lm, idx) => {
                    if (res.multiHandedness[idx].label === "Right") {
                        rotYTarget = (lm[9].x - 0.5) * 6;
                        rotXTarget = (lm[9].y - 0.5) * 3;
                    } else {
                        const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                        zoomTarget = d * 6;
                        if(zoomTarget < 0.6) zoomTarget = 0.6;
                    }
                });
            }
        });
        const cam = new Camera(video, {onFrame: async () => await hands.send({image: video}), width: 640, height: 480});
        cam.start();
    }

    function capture() {
        const link = document.createElement('a');
        link.href = renderer.domElement.toDataURL();
        link.download = 'Xmas_Selfie.png'; link.click();
    }
</script>
</body>
</html>
