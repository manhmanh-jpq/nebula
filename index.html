<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xmas Ultimate - Perfect Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        
        /* Filter m·∫∑t m·ªù ·∫£o ph√≠a sau c√¢y th√¥ng */
        #face-filter { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; 
            opacity: 0; transition: opacity 0.5s; z-index: 0; filter: blur(5px) brightness(0.7);
            transform: scaleX(-1);
        }

        #ui-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; pointer-events: none; z-index: 10;
        }
        .guide-main { font-size: 24px; font-weight: bold; text-shadow: 0 0 10px #000; }

        #update-picker {
            position: absolute; top: 20px; right: 20px; background: rgba(20,20,20,0.8);
            padding: 15px; border-radius: 10px; border: 1px solid #444; color: white; width: 220px; z-index: 100;
        }
        .row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; font-size: 13px; }
        input[type="color"] { background: none; border: none; width: 45px; height: 22px; cursor: pointer; }

        #pip-container { 
            position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; 
            border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 100;
        }
        #pip-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        #bottom-bar {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .btn {
            background: white; color: black; padding: 12px 25px; border-radius: 30px;
            font-weight: 900; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>

    <video id="face-filter" autoplay playsinline></video>
    
    <div id="ui-overlay">
        <div id="instruction" class="guide-main">1 Tay: Xoay 360 ƒë·ªô | 2 Tay: Thu ph√≥ng</div>
    </div>

    <div id="update-picker">
        <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #444;">Update picker</div>
        <div class="row">L√° 1 <input type="color" id="c1" value="#004d00"></div>
        <div class="row">L√° 2 <input type="color" id="c2" value="#006900"></div>
        <div class="row">L√° 3 <input type="color" id="c3" value="#008000"></div>
        <div class="row">L√° 4 <input type="color" id="c4" value="#228b22"></div>
        <div class="row">L√° 5 <input type="color" id="c5" value="#32cd32"></div>
        <div class="row">D√¢y ƒë√®n <input type="color" id="c6" value="#ffcc00"></div>
    </div>

    <div id="pip-container"><video id="pip-video" autoplay playsinline></video></div>

    <div id="bottom-bar">
        <button class="btn" onclick="capture()">üì∑ n√∫t n√†y ƒë·ªÉ ch·ª•p ·∫£nh</button>
        <button class="btn" onclick="toggleRecord()">üéôÔ∏è ·∫§n v√†o ƒë√¢y ƒë·ªÉ quay video k√®m Mic nh√©</button>
    </div>

    <div id="canvas-container"></div>

<script>
    let scene, camera, renderer, treeGroup, textSprite, heartParticles;
    let zoomTarget = 1, rotYTarget = 0, currentZoom = 1, currentRotY = 0;
    let state = "TREE"; 
    const SMOOTH_FACTOR = 0.035; // ƒê·ªô n·∫∑ng ƒë·∫±m tay khi xoay

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
        camera.position.z = 850;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        treeGroup = new THREE.Group();
        scene.add(treeGroup);

        // Text Sprite cho c√°c th√¥ng ƒëi·ªáp b√≠ m·∫≠t
        const canvas = document.createElement('canvas');
        canvas.width = 1024; canvas.height = 256;
        const tex = new THREE.CanvasTexture(canvas);
        textSprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex, transparent: true, depthTest: false}));
        textSprite.scale.set(600, 150, 1);
        scene.add(textSprite);

        // H·∫°t tr√°i tim
        const heartGeo = new THREE.BufferGeometry();
        const heartPos = new Float32Array(15000 * 3);
        heartGeo.setAttribute('position', new THREE.BufferAttribute(heartPos, 3));
        heartParticles = new THREE.Points(heartGeo, new THREE.PointsMaterial({
            color: 0xff0000, size: 4, transparent: true, blending: THREE.AdditiveBlending,
            map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/circle.png')
        }));
        heartParticles.visible = false;
        scene.add(heartParticles);

        updateTree();
        animate();
        startCamera();
    }

    function updateTree() {
        while(treeGroup.children.length > 0) treeGroup.remove(treeGroup.children[0]);
        const colors = [1,2,3,4,5,6].map(i => document.getElementById('c'+i).value);

        // 5 T·∫ßng L√° Neon
        for(let i=0; i<5; i++) {
            const r = 220 - i*40;
            const cone = new THREE.LineSegments(
                new THREE.EdgesGeometry(new THREE.ConeGeometry(r, 120, 8, 1, true)),
                new THREE.LineBasicMaterial({color: colors[i], linewidth: 2})
            );
            cone.position.y = -180 + i*80;
            treeGroup.add(cone);
        }

        // D√¢y ƒë√®n xo·∫Øn ·ªëc (CatmullRomCurve3)
        const curvePts = [];
        for(let i=0; i<150; i++) {
            const t = i/150; const a = t*Math.PI*12; const r = (1-t)*220;
            curvePts.push(new THREE.Vector3(Math.cos(a)*r, -240 + t*480, Math.sin(a)*r));
        }
        const spiralGeo = new THREE.BufferGeometry().setFromPoints(curvePts);
        treeGroup.add(new THREE.Points(spiralGeo, new THREE.PointsMaterial({color: colors[5], size: 5})));
    }

    function animate() {
        requestAnimationFrame(animate);
        currentRotY += (rotYTarget - currentRotY) * SMOOTH_FACTOR;
        currentZoom += (zoomTarget - currentZoom) * SMOOTH_FACTOR;
        
        treeGroup.rotation.y = currentRotY;
        heartParticles.rotation.y = currentRotY;
        camera.position.z = 850 - (currentZoom - 1) * 1600;

        const ctx = textSprite.material.map.image.getContext('2d');
        ctx.clearRect(0,0,1024,256);
        ctx.textAlign = "center"; ctx.fillStyle = "white"; ctx.font = "bold 55px Arial";

        // Logic Chui L√µi & Ch·ªØ bi·∫øn ƒë·ªïi
        if (state === "TREE") {
            if (camera.position.z < 150) {
                ctx.fillText("Merry Christmas!", 512, 128);
                textSprite.material.opacity = 1;
                // Ch√∫ th√≠ch nh·ªè gi·ªØa m√†n h√¨nh
                document.getElementById('instruction').innerText = "l·∫•y m·ªôt b√†n tay ƒë·ªÉ xoay h√¨nh ƒëi";
                
                // Ki·ªÉm tra xoay 180 ƒë·ªô (x·∫•p x·ªâ PI)
                if (Math.abs(currentRotY % (Math.PI * 2)) > Math.PI * 0.8) {
                    document.getElementById('instruction').innerText = "N·∫Øm tay v√†o ƒëi";
                }
            } else {
                textSprite.material.opacity = 0;
                document.getElementById('instruction').innerText = "1 Tay: Xoay 360 ƒë·ªô | 2 Tay: Thu ph√≥ng";
            }
        } else if (state === "HEART") {
            ctx.fillText("tao ch∆∞a c√≥ qu√† ^ ^", 512, 128);
            textSprite.material.opacity = 1;
        }

        textSprite.material.map.needsUpdate = true;
        renderer.render(scene, camera);
    }

    function createHeartBurst() {
        state = "HEART";
        treeGroup.visible = false;
        heartParticles.visible = true;
        const p = heartParticles.geometry.attributes.position.array;
        for(let i=0; i<15000; i++) {
            const t = Math.random()*Math.PI*2;
            const h = Math.random()*Math.PI;
            p[i*3] = 20 * 16 * Math.pow(Math.sin(t), 3) * Math.sin(h);
            p[i*3+1] = 20 * (13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t)) * Math.sin(h);
            p[i*3+2] = 20 * 10 * Math.cos(h) * Math.sin(h);
        }
        heartParticles.geometry.attributes.position.needsUpdate = true;
        setTimeout(() => { state = "TREE"; treeGroup.visible = true; heartParticles.visible = false; }, 7000);
    }

    async function startCamera() {
        const video = document.getElementById('pip-video');
        const filterVid = document.getElementById('face-filter');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8});
        
        hands.onResults(res => {
            if(res.multiHandLandmarks.length === 1) {
                const lm = res.multiHandLandmarks[0];
                // Xoay 1 tay
                rotYTarget += (lm[8].x - 0.5) * 0.2;
                
                // Logic N·∫Øm ƒë·∫•m (Fist) -> Tr√°i tim
                const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y && lm[16].y > lm[14].y;
                if(isFist && state !== "HEART") createHeartBurst();

            } else if(res.multiHandLandmarks.length === 2) {
                const d = Math.hypot(res.multiHandLandmarks[0][9].x - res.multiHandLandmarks[1][9].x, 
                                     res.multiHandLandmarks[0][9].y - res.multiHandLandmarks[1][9].y);
                zoomTarget = 0.8 + d * 4;
            }
        });

        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        video.srcObject = stream;
        filterVid.srcObject = stream;
        const cam = new Camera(video, {onFrame: async () => await hands.send({image: video}), width: 640, height: 480});
        cam.start();
    }

    function toggleRecord() {
        const filter = document.getElementById('face-filter');
        filter.style.opacity = filter.style.opacity == "0.4" ? "0" : "0.4";
        alert("ƒêang chu·∫©n b·ªã quay k√®m m·∫∑t m·ªù ·∫£o v√† Micro...");
    }

    function capture() {
        const link = document.createElement('a');
        link.href = renderer.domElement.toDataURL();
        link.download = 'xmas_snap.png'; link.click();
    }

    document.querySelectorAll('input').forEach(i => i.onchange = updateTree);
    init();
</script>
</body>
</html>
