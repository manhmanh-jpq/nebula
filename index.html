<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xmas Perfected - Nitro 16 Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #080808; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        
        /* Ch√∫ th√≠ch h∆∞·ªõng d·∫´n */
        #instruction-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; pointer-events: none; z-index: 10;
        }
        .main-hint { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 10px #fff; }
        .sub-hint { font-size: 16px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; }

        /* B·∫£ng m√†u 5 t·∫ßng l√° (g√≥c ph·∫£i) */
        #update-picker {
            position: absolute; top: 20px; right: 20px; background: rgba(20,20,20,0.9);
            padding: 15px; border-radius: 10px; border: 1px solid #444; color: white; width: 240px; z-index: 100;
        }
        .row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; font-size: 13px; }
        input[type="color"] { background: none; border: none; width: 45px; height: 22px; cursor: pointer; }

        /* Camera nh·ªè (PiP) */
        #pip-container { 
            position: absolute; bottom: 20px; right: 20px; width: 220px; height: 165px; 
            border: 2px solid #fff; border-radius: 12px; overflow: hidden; z-index: 100;
        }
        #pip-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* Thanh ƒëi·ªÅu khi·ªÉn d∆∞·ªõi c√πng */
        #controls {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .btn {
            background: white; color: black; padding: 12px 25px; border-radius: 30px;
            font-weight: 900; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>

    <div id="instruction-overlay">
        <div class="main-hint" id="hint-text">1 Tay: Xoay 360 ƒë·ªô | 2 Tay: Thu ph√≥ng</div>
        <div class="sub-hint">Xoay 180 ƒë·ªô b√™n trong ƒë·ªÉ t√¨m b√≠ m·∫≠t</div>
    </div>

    <div id="update-picker">
        <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #333;">Update picker</div>
        <div class="row">Sao <input type="color" id="c0" value="#ffff00"></div>
        <div class="row">L√° t·∫ßng 1 <input type="color" id="c1" value="#004d00"></div>
        <div class="row">L√° t·∫ßng 2 <input type="color" id="c2" value="#006900"></div>
        <div class="row">L√° t·∫ßng 3 <input type="color" id="c3" value="#008000"></div>
        <div class="row">L√° t·∫ßng 4 <input type="color" id="c4" value="#228b22"></div>
        <div class="row">L√° t·∫ßng 5 <input type="color" id="c5" value="#32cd32"></div>
        <div class="row">D√¢y ƒë√®n <input type="color" id="c6" value="#ffcc00"></div>
        <div class="row">G·ªëc <input type="color" id="c7" value="#2d1a00"></div>
    </div>

    <div id="pip-container"><video id="pip-video" autoplay playsinline></video></div>

    <div id="controls">
        <button class="btn" onclick="capture()">üì∑ n√∫t n√†y ƒë·ªÉ ch·ª•p ·∫£nh</button>
        <button class="btn" onclick="toggleRecord()">üéôÔ∏è ·∫§n v√†o ƒë√¢y ƒë·ªÉ quay video k√®m Mic nh√©</button>
    </div>

    <div id="canvas-container"></div>

<script>
    let scene, camera, renderer, treeGroup, textGroup, spiralLights;
    let zoomTarget = 1, rotYTarget = 0, currentZoom = 1, currentRotY = 0;
    const SMOOTH_FACTOR = 0.035; // ƒê·ªô l√¨ ƒë·∫±m tay

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
        camera.position.z = 800;

        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        treeGroup = new THREE.Group();
        scene.add(treeGroup);

        textGroup = new THREE.Group();
        scene.add(textGroup);

        createAdvancedTree();
        createSecretText();
        animate();
        startCamera();
    }

    function createAdvancedTree() {
        while(treeGroup.children.length > 0) treeGroup.remove(treeGroup.children[0]);
        const cols = [0,1,2,3,4,5,6,7].map(i => document.getElementById('c'+i).value);

        // 1. G·ªëc c√¢y
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(20, 25, 60, 12), new THREE.MeshBasicMaterial({color: cols[7]}));
        trunk.position.y = -250;
        treeGroup.add(trunk);

        // 2. 5 T·∫ßng L√° (Neon Line + Particle Cloud)
        for(let i=0; i<5; i++) {
            const r = 220 - i*40;
            const h = 130;
            const yPos = -180 + i*85;

            // Khung Neon
            const cone = new THREE.LineSegments(
                new THREE.EdgesGeometry(new THREE.ConeGeometry(r, h, 8, 1, true)),
                new THREE.LineBasicMaterial({color: cols[i+1], transparent: true, opacity: 0.8})
            );
            cone.position.y = yPos;
            treeGroup.add(cone);

            // L·ªõp h·∫°t b·ª•i cho m·ªói t·∫ßng
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            for(let j=0; j<800; j++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * r;
                pPos.push(Math.cos(angle)*radius, (Math.random()-0.5)*15, Math.sin(angle)*radius);
            }
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            const pPoints = new THREE.Points(pGeo, new THREE.PointsMaterial({color: cols[i+1], size: 2, transparent: true, opacity: 0.5}));
            pPoints.position.y = yPos;
            treeGroup.add(pPoints);
        }

        // 3. D√¢y ƒë√®n Fairy Lights (CatmullRomCurve3)
        const curvePoints = [];
        for(let i=0; i<=100; i++) {
            const t = i/100;
            const angle = t * Math.PI * 14;
            const radius = (1 - t) * 220;
            curvePoints.push(new THREE.Vector3(Math.cos(angle)*radius, -230 + t*460, Math.sin(angle)*radius));
        }
        const curve = new THREE.CatmullRomCurve3(curvePoints);
        const lightGeo = new THREE.BufferGeometry().setFromPoints(curve.getPoints(200));
        spiralLights = new THREE.Points(lightGeo, new THREE.PointsMaterial({
            color: cols[6], size: 6, transparent: true, blending: THREE.AdditiveBlending,
            map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/circle.png')
        }));
        treeGroup.add(spiralLights);

        // 4. Ng√¥i sao ƒë·ªânh
        const star = new THREE.Mesh(new THREE.SphereGeometry(22, 12, 12), new THREE.MeshBasicMaterial({color: cols[0]}));
        star.position.y = 250;
        treeGroup.add(star);
    }

    function createSecretText() {
        const createLabel = (txt) => {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.font = "bold 80px Arial"; ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText(txt, 512, 128);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex, transparent: true, depthTest: false}));
            sprite.scale.set(500, 125, 1);
            return sprite;
        };

        const label1 = createLabel("Merry Christmas!");
        label1.position.z = 20; 
        textGroup.add(label1);

        const label2 = createLabel("Tao ch∆∞a c√≥ qu√†");
        label2.rotation.y = Math.PI; // Xoay 180 ƒë·ªô
        label2.position.z = -20;
        textGroup.add(label2);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        currentRotY += (rotYTarget - currentRotY) * SMOOTH_FACTOR;
        currentZoom += (zoomTarget - currentZoom) * SMOOTH_FACTOR;
        
        treeGroup.rotation.y = currentRotY;
        textGroup.rotation.y = currentRotY;
        
        // Kho·∫£ng c√°ch zoom t·ªëi ƒëa ƒë·ªÉ "bay v√†o l√µi"
        camera.position.z = 800 - (currentZoom - 1) * 1600;

        // Hi·ªáu ·ª©ng hi·ªán ch√∫ th√≠ch v√† ch·ªØ
        const hint = document.getElementById('hint-text');
        if (camera.position.z < 100) {
            textGroup.visible = true;
            hint.innerText = "l·∫•y m·ªôt b√†n tay ƒë·ªÉ xoay h√¨nh ƒëi";
        } else {
            textGroup.visible = false;
            hint.innerText = "1 Tay: Xoay 360 ƒë·ªô | 2 Tay: Thu ph√≥ng";
        }

        // Nh·∫•p nh√°y ƒë√®n d√¢y
        if(spiralLights) spiralLights.material.opacity = 0.4 + Math.sin(Date.now()*0.005)*0.4;

        renderer.render(scene, camera);
    }

    async function startCamera() {
        const video = document.getElementById('pip-video');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8});
        
        hands.onResults(res => {
            if(res.multiHandLandmarks.length === 1) {
                // Xoay 360 ƒë·ªô m∆∞·ª£t m√† b·∫±ng 1 tay
                rotYTarget += (res.multiHandLandmarks[0][8].x - 0.5) * 0.2;
            } else if(res.multiHandLandmarks.length === 2) {
                // Thu ph√≥ng b·∫±ng x√≤e/ch·ª•m 2 tay
                const h1 = res.multiHandLandmarks[0][9];
                const h2 = res.multiHandLandmarks[1][9];
                const dist = Math.hypot(h1.x - h2.x, h1.y - h2.y);
                zoomTarget = 0.8 + dist * 4.0;
            }
        });
        const cam = new Camera(video, {onFrame: async () => await hands.send({image: video}), width: 640, height: 480});
        cam.start();
    }

    function capture() {
        const link = document.createElement('a');
        link.href = renderer.domElement.toDataURL();
        link.download = 'xmas_photo.png'; link.click();
    }

    function toggleRecord() {
        alert("T√≠nh nƒÉng Quay Video ƒëang kh·ªüi t·∫°o... (Y√™u c·∫ßu quy·ªÅn truy c·∫≠p Mic)");
        // Logic MediaRecorder c√≥ th·ªÉ th√™m t·∫°i ƒë√¢y
    }

    document.querySelectorAll('input').forEach(i => i.onchange = createAdvancedTree);
    init();
</script>
</body>
</html>
