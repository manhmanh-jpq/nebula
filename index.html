<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nebula Studio - Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #webcam { position: absolute; top: 10px; right: 10px; width: 220px; z-index: 10; transform: scaleX(-1); border: 2px solid #00ffff; border-radius: 8px; }
    </style>
</head>
<body>
    <video id="webcam" autoplay playsinline style="display:none"></video>
    <canvas id="output_canvas" style="position:absolute; top:10px; right:10px; width:220px; transform:scaleX(-1); border:2px solid #0ff; z-index:100; border-radius:8px;"></canvas>
    
    <script>
        let scene, camera, renderer, particles;
        let expansion = 0, targetExpansion = 0;

        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // KHỞI TẠO ĐỒ HỌA
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const pts = new Float32Array(15000 * 3);
        for(let i=0; i<45000; i++) pts[i] = (Math.random() - 0.5) * 6;
        geo.setAttribute('position', new THREE.BufferAttribute(pts, 3));
        particles = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x00ffff, size: 0.02 }));
        scene.add(particles);

        // KHỞI TẠO AI HANDS
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        
        hands.onResults((results) => {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                const h1 = results.multiHandLandmarks[0][9];
                const h2 = results.multiHandLandmarks[1][9];
                const d = Math.sqrt(Math.pow(h1.x-h2.x,2) + Math.pow(h1.y-h2.y,2));
                targetExpansion = d * 10; 
            } else { targetExpansion = 0; }
        });

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraUtils.start();

        function animate() {
            expansion += (targetExpansion - expansion) * 0.1;
            particles.scale.set(1 + expansion, 1 + expansion, 1 + expansion);
            particles.rotation.y += 0.002;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
