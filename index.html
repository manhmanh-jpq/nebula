<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xmas Pro - Fixed & Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; }
        #instruction {
            position: absolute; top: 20px; left: 20px; color: #00ffff; z-index: 100;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;
        }
        #pip-container { 
            position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; 
            border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 100;
        }
        #pip-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #bottom-bar {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .btn { background: white; color: black; padding: 12px 25px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="instruction">
        <b>TAY TR√ÅI:</b> ZOOM (CH·ª§M/X√íE)<br>
        <b>TAY PH·∫¢I:</b> XOAY 360¬∞
    </div>

    <div id="pip-container"><video id="pip-video" autoplay playsinline></video></div>

    <div id="bottom-bar">
        <button class="btn" onclick="capture()">üì∑ CH·ª§P ·∫¢NH</button>
        <button class="btn">üéôÔ∏è QUAY VIDEO</button>
    </div>

    <div id="canvas-container"></div>

<script>
    let scene, camera, renderer, treeGroup, textGroup, starGroup;
    let zoomTarget = 1, rotXTarget = 0, rotYTarget = 0;
    let currentZoom = 1, currentRotX = 0, currentRotY = 0;
    const SMOOTH = 0.05;

    // Hi·ªáu ·ª©ng √¢m thanh Sci-fi khi di chuy·ªÉn
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playMoveSound(val) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(150 + val * 100, audioCtx.currentTime);
        g.gain.setValueAtTime(0.02, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
        camera.position.z = 800;

        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        treeGroup = new THREE.Group();
        scene.add(treeGroup);
        textGroup = new THREE.Group();
        scene.add(textGroup);

        buildTree();
        buildLabels();
        animate();
        setupHands();
    }

    function buildTree() {
        // Ng√¥i sao h·∫°t b·ª•i
        starGroup = new THREE.Group();
        const sGeo = new THREE.BufferGeometry();
        const sPos = [];
        for(let i=0; i<600; i++) {
            const r = Math.random() * 30;
            const theta = Math.random() * 6.28;
            const phi = Math.random() * 3.14;
            sPos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
        }
        sGeo.setAttribute('position', new THREE.Float32BufferAttribute(sPos, 3));
        starGroup.add(new THREE.Points(sGeo, new THREE.PointsMaterial({color: 0xffffaa, size: 2})));
        starGroup.position.y = 300;
        treeGroup.add(starGroup);

        //
