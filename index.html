<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xmas Pro - Final Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; }
        
        /* Ch√∫ th√≠ch ·ªü g√≥c tr√°i ph√≠a tr√™n */
        #instruction-fixed {
            position: absolute; top: 20px; left: 20px;
            color: white; z-index: 100; pointer-events: none;
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px;
            border-left: 4px solid #00ff00;
        }
        .hint-line { font-size: 16px; font-weight: bold; margin: 5px 0; text-transform: uppercase; }

        /* B·∫£ng m√†u v√† Camera nh·ªè gi·ªØ nguy√™n */
        #update-picker {
            position: absolute; top: 20px; right: 20px; background: rgba(20,20,20,0.9);
            padding: 15px; border-radius: 10px; border: 1px solid #444; color: white; width: 220px; z-index: 100;
        }
        .row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 12px; }
        #pip-container { 
            position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; 
            border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 100;
        }
        #pip-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* N√∫t b·∫•m */
        #bottom-bar {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .btn { background: white; color: black; padding: 12px 25px; border-radius: 30px; font-weight: 900; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="instruction-fixed">
        <div class="hint-line" style="color: #00ff00;">‚óè TAY TR√ÅI: Ch·ª•m/X√≤e ƒë·ªÉ ZOOM</div>
        <div class="hint-line" style="color: #ff0000;">‚óè TAY PH·∫¢I: Di chuy·ªÉn ƒë·ªÉ XOAY 360¬∞</div>
    </div>

    <audio id="bg-music" loop>
        <source src="https://www.chosic.com/wp-content/uploads/2021/11/We-Wish-You-A-Merry-Christmas-Lofi.mp3" type="audio/mpeg">
    </audio>

    <div id="update-picker">
        <div style="font-weight:bold; margin-bottom:10px;">Update picker</div>
        <div class="row">Sao <input type="color" id="c0" value="#ffff00"></div>
        <div class="row">L√° 1-8 <input type="color" id="c1" value="#006400"></div>
        <div class="row">D√¢y ƒë√®n <input type="color" id="c6" value="#ffee00"></div>
        <div class="row">G·ªëc <input type="color" id="c7" value="#3d2b1f"></div>
    </div>

    <div id="pip-container"><video id="pip-video" autoplay playsinline></video></div>

    <div id="bottom-bar">
        <button class="btn" onclick="capture()">üì∑ CH·ª§P ·∫¢NH</button>
        <button class="btn" onclick="startAudio()">üéµ B·∫¨T NH·∫†C & QUAY</button>
    </div>

    <div id="canvas-container"></div>

<script>
    let scene, camera, renderer, treeGroup, textGroup, secretHint;
    let zoomTarget = 1, rotXTarget = 0, rotYTarget = 0;
    let currentZoom = 1, currentRotX = 0, currentRotY = 0;
    const SMOOTH = 0.04;

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 5000);
        camera.position.z = 800;

        renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        treeGroup = new THREE.Group();
        scene.add(treeGroup);
        textGroup = new THREE.Group();
        scene.add(textGroup);

        createMultiLayerTree();
        createLabels();
        animate();
        startCamera();
    }

    function createMultiLayerTree() {
        while(treeGroup.children.length > 0) treeGroup.remove(treeGroup.children[0]);
        const cols = [0,1,6,7].map(i => document.getElementById('c'+i).value);

        // T·∫°o 10 t·∫ßng l√° cho d√†y
        for(let i=0; i<10; i++) {
            const r = 260 - i*25;
            const y = -220 + i*60;
            
            // Khung n√≥n Neon
            const cone = new THREE.LineSegments(
                new THREE.EdgesGeometry(new THREE.ConeGeometry(r, 140, 10, 1, true)),
                new THREE.LineBasicMaterial({color: cols[1], transparent: true, opacity: 0.5})
            );
            cone.position.y = y;
            treeGroup.add(cone);

            // H·∫°t b·ª•i d√†y ƒë·∫∑c
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            for(let j=0; j<1200; j++) {
                const a = Math.random() * Math.PI * 2;
                const rad = Math.random() * r;
                pPos.push(Math.cos(a)*rad, (Math.random()-0.5)*20, Math.sin(a)*rad);
            }
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            const pPoints = new THREE.Points(pGeo, new THREE.PointsMaterial({color: cols[1], size: 2}));
            pPoints.position.y = y;
            treeGroup.add(pPoints);
        }

        // G·ªëc
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(25, 30, 80), new THREE.MeshBasicMaterial({color: cols[3]}));
        trunk.position.y = -280;
        treeGroup.add(trunk);
    }

    function createLabels() {
        const createT = (txt) => {
            const can = document.createElement('canvas');
            can.width = 1024; can.height = 256;
            const ctx = can.getContext('2d');
            ctx.font = "bold 90px Arial"; ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText(txt, 512, 128);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(can), transparent: true, depthTest: false}));
            sprite.scale.set(600, 150, 1);
            return sprite;
        };
        const m1 = createT("Merry Christmas!"); m1.position.z = 30; textGroup.add(m1);
        const m2 = createT("Tao ch∆∞a c√≥ qu√†"); m2.rotation.y = Math.PI; m2.position.z = -30; textGroup.add(m2);

        // D√≤ng ch√∫ th√≠ch nh·ªè xu·∫•t hi·ªán gi·ªØa m√†n h√¨nh khi zoom v√†o
        secretHint = createT("l·∫•y m·ªôt b√†n tay ƒë·ªÉ xoay h√¨nh ƒëi");
        secretHint.scale.set(400, 100, 1);
        secretHint.position.y = -150;
        secretHint.visible = false;
        scene.add(secretHint);
    }

    function animate() {
        requestAnimationFrame(animate);
        currentRotY += (rotYTarget - currentRotY) * SMOOTH;
        currentRotX += (rotXTarget - currentRotX) * SMOOTH;
        currentZoom += (zoomTarget - currentZoom) * SMOOTH;
        
        treeGroup.rotation.y = currentRotY;
        treeGroup.rotation.x = currentRotX;
        textGroup.rotation.y = currentRotY;
        textGroup.rotation.x = currentRotX;
        
        camera.position.z = 800 - (currentZoom - 1) * 1600;

        // Logic hi·ªán ch·ªØ b√≠ m·∫≠t
        if (camera.position.z < 150) {
            textGroup.visible = true;
            secretHint.visible = true;
        } else {
            textGroup.visible = false;
            secretHint.visible = false;
        }

        renderer.render(scene, camera);
    }

    async function startCamera() {
        const video = document.getElementById('pip-video');
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7});
        
        hands.onResults(res => {
            if(res.multiHandLandmarks && res.multiHandedness) {
                res.multiHandLandmarks.forEach((landmarks, index) => {
                    const isRightHand = res.multiHandedness[index].label === "Right";
                    
                    if (isRightHand) { 
                        // TAY PH·∫¢I: XOAY
                        rotYTarget = (landmarks[9].x - 0.5) * Math.PI * 3;
                        rotXTarget = (landmarks[9].y - 0.5) * Math.PI;
                    } else {
                        // TAY TR√ÅI: ZOOM
                        const d = Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y);
                        zoomTarget = d * 5.5; 
                        if(zoomTarget < 0.6) zoomTarget = 0.6;
                    }
                });
            }
        });
        const cam = new Camera(video, {onFrame: async () => await hands.send({image: video}), width: 640, height: 480});
        cam.start();
    }

    function startAudio() {
        document.getElementById('bg-music').play();
        alert("Nh·∫°c ƒë√£ b·∫≠t! H√£y b·∫Øt ƒë·∫ßu t∆∞∆°ng t√°c.");
    }

    function capture() {
        const link = document.createElement('a');
        link.href = renderer.domElement.toDataURL();
        link.download = 'Xmas_Moment.png'; link.click();
    }

    document.querySelectorAll('input').forEach(i => i.onchange = createMultiLayerTree);
    init();
</script>
</body>
</html>
