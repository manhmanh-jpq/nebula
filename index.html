<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmas Pro - Final Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Camera g√≥c nh·ªè (PIP) */
        #pip-video { 
            position: absolute; bottom: 20px; right: 20px; width: 220px; height: 160px; 
            border: 2px solid #fff; border-radius: 15px; z-index: 100; 
            transform: scaleX(-1); object-fit: cover; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* B·∫£ng ch√∫ th√≠ch t·ªëi gi·∫£n */
        #help-box { 
            position: absolute; top: 20px; left: 20px; z-index: 20; 
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; color: white;
            border-left: 4px solid #ff0000; pointer-events: none;
        }
        .info { margin: 5px 0; font-size: 13px; font-weight: 600; }

        /* Giao di·ªán n√∫t b·∫•m */
        #ui-layer { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10; display: flex; gap: 20px; }
        .btn { 
            background: #fff; border: none; padding: 12px 24px; border-radius: 50px; 
            cursor: pointer; font-weight: 800; transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: scale(1.05); background: #f0f0f0; }

        /* Ch·ªçn m√†u */
        #color-settings { 
            position: absolute; top: 20px; right: 20px; z-index: 10; 
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; color: white; font-size: 12px;
        }
        .color-row { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin: 5px 0; }
        input[type="color"] { border: none; width: 22px; height: 22px; cursor: pointer; background: none; }
    </style>
</head>
<body>

    <video id="pip-video" autoplay playsinline></video>
    <div id="canvas-container"></div>

    <div id="help-box">
        <div class="info">üñêÔ∏è 1 Tay: Xoay 360 ƒë·ªô</div>
        <div class="info">üôå 2 Tay: M·ªü r·ªông / Thu ph√≥ng</div>
        <div class="info">üé® M√†u: Sao, 5 t·∫ßng l√°, G·ªëc</div>
    </div>

    <div id="ui-layer">
        <button class="btn" onclick="takePhoto()">üì∑ ·∫§N V√ÄO ƒê√ÇY ƒê·ªÇ SELFI NH√ì BABE</button>
        <button class="btn" onclick="alert('B·∫Øt ƒë·∫ßu quay k√®m Mic...')">üéôÔ∏è ·ªû ƒê√ÇY L√Ä QUAY K√àM MIC LU√îN ƒê√ì</button>
    </div>

    <div id="color-settings">
        <div class="color-row">Sao <input type="color" id="cStar" value="#ffff00"></div>
        <div class="color-row">L√° 1 <input type="color" id="c1" value="#003300"></div>
        <div class="color-row">L√° 2 <input type="color" id="c2" value="#004d00"></div>
        <div class="color-row">L√° 3 <input type="color" id="c3" value="#006600"></div>
        <div class="color-row">L√° 4 <input type="color" id="c4" value="#008000"></div>
        <div class="color-row">L√° 5 <input type="color" id="c5" value="#228b22"></div>
        <div class="color-row">G·ªëc <input type="color" id="cTrunk" value="#4b240a"></div>
    </div>

    <script>
        let scene, camera, renderer, points, geometry, labelSprite;
        const count = 20000;
        let targetZoom = 1, targetRotY = 0, currentStatus = "tree";
        let lerpZoom = 1, lerpRotY = 0;

        function createPointTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(32,32,0,32,32,32);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0.3)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad; ctx.arc(32,32,32,0,Math.PI*2); ctx.fill();
            return new THREE.CanvasTexture(canvas);
        }

        function makeTextSprite(message) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.font = "Bold 80px Arial";
            ctx.textAlign = "center";
            ctx.fillStyle = "white";
            ctx.shadowColor = "rgba(0,0,0,1)";
            ctx.shadowBlur = 10;
            ctx.fillText(message, 512, 128);
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(400, 100, 1);
            return sprite;
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 2500);
            camera.position.z = 700;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            geometry = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            const cols = new Float32Array(count * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(cols, 3));

            const material = new THREE.PointsMaterial({
                size: 5, vertexColors: true, map: createPointTexture(),
                transparent: true, blending: THREE.AdditiveBlending, depthWrite: false
            });

            points = new THREE.Points(geometry, material);
            scene.add(points);

            labelSprite = makeTextSprite("");
            labelSprite.position.set(0, 0, 0);
            scene.add(labelSprite);

            buildTree();
            animate();
            setupAR();
        }

        function buildTree() {
            const pos = geometry.attributes.position.array;
            const cols = geometry.attributes.color.array;
            const cList = [id('c1'), id('c2'), id('c3'), id('c4'), id('c5')].map(i => new THREE.Color(i.value));
            const sCol = new THREE.Color(id('cStar').value);
            const tCol = new THREE.Color(id('cTrunk').value);

            for(let i=0; i<count; i++) {
                let x, y, z, c;
                const r = Math.random();
                if(r > 0.15) { // Tree Tiers
                    const t = Math.floor(Math.random()*5);
                    const h = -180 + t*70 + Math.random()*70;
                    const rad = (350 - (h+180)) * 0.45 * Math.random();
                    const a = Math.random() * Math.PI * 2;
                    x = Math.cos(a)*rad; y = h; z = Math.sin(a)*rad;
                    c = cList[t];
                } else if(r > 0.03) { // Trunk
                    x = (Math.random()-0.5)*40; y = -180-Math.random()*80; z = (Math.random()-0.5)*40;
                    c = tCol;
                } else { // Star
                    const a = Math.random()*Math.PI*2; const rad = Math.random()*40;
                    x = Math.cos(a)*rad; y = 200+Math.random()*50; z = Math.sin(a)*rad;
                    c = sCol;
                }
                pos[i*3]=x; pos[i*3+1]=y; pos[i*3+2]=z;
                cols[i*3]=c.r; cols[i*3+1]=c.g; cols[i*3+2]=c.b;
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
        }

        function buildHeart() {
            const pos = geometry.attributes.position.array;
            const cols = geometry.attributes.color.array;
            for(let i=0; i<count; i++) {
                // C√¥ng th·ª©c Tr√°i tim 3D chu·∫©n x√°c
                const t = Math.random() * Math.PI * 2;
                const p = Math.random() * Math.PI;
                const r = 18;
                const x = r * 16 * Math.pow(Math.sin(t), 3) * Math.sin(p);
                const y = r * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * Math.sin(p);
                const z = r * 10 * Math.cos(p) * Math.sin(p); 
                pos[i*3]=x; pos[i*3+1]=y; pos[i*3+2]=z;
                cols[i*3]=1; cols[i*3+1]=0; cols[i*3+2]=0.2; 
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
        }

        function id(name) { return document.getElementById(name); }

        function animate() {
            requestAnimationFrame(animate);
            lerpRotY += (targetRotY - lerpRotY) * 0.05;
            lerpZoom += (targetZoom - lerpZoom) * 0.05;
            points.rotation.y = lerpRotY;
            camera.position.z = 700 - (lerpZoom - 1) * 1400;

            if(camera.position.z < 0 && currentStatus === "tree") {
                if(labelSprite.material.map.image) {
                    const ctx = labelSprite.material.map.image.getContext('2d');
                    ctx.clearRect(0,0,1024,256);
                    ctx.fillText("l√†m tr√°i tim ƒëi s·∫Ω c√≥ b·∫•t ng·ªù", 512, 128);
                    labelSprite.material.map.needsUpdate = true;
                }
                labelSprite.material.opacity = 1;
            } else if(currentStatus === "heart") {
                const ctx = labelSprite.material.map.image.getContext('2d');
                ctx.clearRect(0,0,1024,256);
                ctx.fillText("tao ch∆∞a c√≥ qu√† ^ ^", 512, 128);
                labelSprite.material.map.needsUpdate = true;
                labelSprite.material.opacity = 1;
                points.rotation.y += 0.02;
            } else {
                labelSprite.material.opacity = 0;
            }
            renderer.render(scene, camera);
        }

        async function setupAR() {
            const video = id('pip-video');
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.8});
            hands.onResults(res => {
                if(res.multiHandLandmarks.length === 1) {
                    targetRotY = (res.multiHandLandmarks[0][8].x - 0.5) * Math.PI * 2;
                } else if(res.multiHandLandmarks.length === 2) {
                    const h1 = res.multiHandLandmarks[0], h2 = res.multiHandLandmarks[1];
                    targetZoom = Math.max(1, Math.hypot(h1[9].x - h2[9].x, h1[9].y - h2[9].y) * 4.5);
                    const d1 = Math.hypot(h1[4].x - h2[4].x, h1[4].y - h2[4].y);
                    const d2 = Math.hypot(h1[8].x - h2[8].x, h1[8].y - h2[8].y);
                    if(d1 < 0.06 && d2 < 0.06 && currentStatus === "tree") {
                        currentStatus = "heart"; buildHeart();
                        setTimeout(() => { currentStatus = "tree"; buildTree(); }, 6000);
                    }
                }
            });
            const cam = new Camera(video, {onFrame: async () => await hands.send({image: video}), width: 640, height: 480});
            cam.start();
        }

        function takePhoto() {
            const link = document.createElement('a');
            link.download = 'xmas_selfie.png';
            link.href = renderer.domElement.toDataURL();
            link.click();
        }

        document.querySelectorAll('input[type="color"]').forEach(el => el.onchange = updateColors);
        function updateColors() { if(currentStatus === "tree") buildTree(); }

        init();
    </script>
</body>
</html>
